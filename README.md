# MessageServiceLaravel
___

## Описание проекта
Данный проект предназначен для демонстрации навыков в программировании на **PHP** и разработки приложения с использованием фреймворка **Laravel**. В проекте согласно техническому заданию реализован механизм позволяющий пользователям регистрироваться, авторизовываться и посылать друг другу сообщения. В качестве программного стека использовались: язык программирования PHP - 7.4, фреймворк Laravel - 5.5, база данных PostgreSQL, BootStrap 5.

___

## Установка и настройка проекта
 + Клонировать проект git@github.com:skulsik/MessageServiceLaravel.git
 + переход в рабочую папку, выполните команду в терминале: cd message_service
 + установка зависимостей, выполните команду в терминале: composer install
 + генерация ключа проекта, выполните команду в терминале: php artisan key:generate
 + в папке message_service создайте фаил .env и скопируйте туда все содержимое файла .env.example
 + создайте базу данных(через консоль или через программы с интерфейсом) с названием message_service, либо придумайте свое
 + в файле .env в настройках DB укажите: назавание базы данных, если вы создали бд под своим названием; имя пользователя и пароль
 + сделайте миграции, выполните команду в терминале: php artisan migrate
 + запустите проект и наслаждайтесь тестами, выполните команду в терминале: php artisan serve

___

## Функционал проекта
Создано преложение в котором посредством встроенных методов (*модуль Auth*), пользователь имеет возможность зарегистрироваться на сайте, авторизоваться и деавторизоваться. Так же, пользователь может отправить сообщение любому другому зарегистрированному пользователю и прочитать сообщения от других зарегистрированных пользователей. Отправка и чтение сообщений возможна только зарегистрированным пользователям. 
> ### Функции
 - [x] Регистрация
 - [x] Авторизация
 - [x] Деавторизация
 - [x] Валидация формы создания сообщения
 - [x] Создание сообщения
 - [x] Чтение сообщений
 - [x] Вывод количества новых сообщений для авторизованного пользователя, пометка нового сообщения в списке

___

## Методы, функции, модели
### Модель MessageModel
```php
    $table->increments('id');
    $table->text('message_text');
    $table->integer('user_id');
    $table->integer('client_id');
    $table->boolean('read');
    $table->dateTime('created_at');
```
В модели используются поля: 
 - message_text - непосредственно текст для самого сообщения
 - user_id - id владельца сообщения
 - client_id - id пользователя которому отправили сообщение
 - read - "true" новое сообщение, "false" сообщение прочитано

### Контроллеры
Кастомная бизнес-логика вынесена в сервисный слой.

 - form_message: передает в отображение текущего авторизованного пользователя и список зарегитрированых пользователей
 - create_message: создает сообщение в базе данных
 - all_messages: получает список сообщений авторизованного пользователя, модифицирует и передает в отображение

### Функция messages_owner_all_modified, в сервисном слое
```php
        // Запрвшивает сообщения, которые принадлежат текущему пользователю
        $this->get_messages_user_auth($user_id);

        $messages_modified = array();
        $count_new_messages = 0;

        foreach ($this->messages_owner_all as $message){
            // Узнает с кем идет переписка
            if ($message->user_id == $user_id) $key = $message->client_id;
            else{
                $key = $message->user_id;

                // Считает количество непрочитанных
                if ($message->read) $count_new_messages++;
            }

            // Превращает объект в коллекцию(нужно для отображения непрочитанных сообщений)
            $message_col = collect($message->toArray())->all();

            // Добавляет собеседника в массив, если его там нет. Собеседнику добавляет объект сообщения.
            if (!array_key_exists($key, $messages_modified)) {
                $messages_modified[$key] = [$users[$key-1], [$message_col]];
            }
            else {
                array_push($messages_modified[$key][1], $message_col);
            }

            // Ставит статус владельца сообщения false - прочитано
            if ($message->client_id == $user_id and $message->read){
                $message->read = false;
                $message->save();
            }
        }

        return array("messages_modified" => $messages_modified, "count_new_messages" => $count_new_messages);
```

#### Работа функции
 - На входе id авторизованного пользователя и список пользователей. 
 - Получает все сообщения принадлежащие авторизованному пользователю. 
 - Запускает цикл по сообщениям. 
 - В первом условии получает id (key) пользователя который написал сообщение авторизованному пользователю. Это необходимо для заполнения массива, сообщения сортируются по id (key). Тут же при условии что написали авторизованному пользователю, если флаг "read == true", то отрабатывает инкремент и подсчитывается количество новых сообщений.
 - Делает из объекта сообщения, дубликат в сообщение - коллекцию. Это нужно для того что бы в массив передать коллекцию, а объект можно было изменить.
 - Построение ассоциативного массива вида: array("id пользователя от которого получаем сообщение" => array("0" => "объект пользователя от которого получаем сообщение", "1" => array("0" => "сообщение", ...)). Работа условия: если ключ не существует в массиве, создает ключ и записывает пользователя и сообщение; иначе в существующий ключ добавляет сообщение.
 - В объекте входящего сообщения, ставит флагу "read" значение false - прочитано.
 - Возвращает сформированный ассоциативный массив с сообщениями и количество новых сообщений.